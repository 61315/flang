---
name: build flang for macos (arm64)

on:
  push:
    branches: [master]
    paths:
      - '.github/workflows/build-macos-arm64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
      - 'Makefile.wasm32'
      - 'scripts/**'
  pull_request:
    branches: [master]
    paths:
      - '.github/workflows/build-macos-arm64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
      - 'Makefile.wasm32'
      - 'scripts/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build-macos-arm64:
    runs-on: macos-latest
    timeout-minutes: 360
    env:
      SCCACHE_GHA_ENABLED: "true"
      CMAKE_C_COMPILER_LAUNCHER: "sccache"
      CMAKE_CXX_COMPILER_LAUNCHER: "sccache"
      TARGET_TRIPLE: "arm64-apple-darwin"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load version configuration
        run: |
          source versions.env
          echo "LLVM_VERSION=$LLVM_VERSION" >> $GITHUB_ENV
          echo "SCCACHE_VERSION=$SCCACHE_VERSION" >> $GITHUB_ENV
          echo "EMSDK_VERSION=$EMSDK_VERSION" >> $GITHUB_ENV
          echo "EMSDK_HASH=$EMSDK_HASH" >> $GITHUB_ENV

      - name: Show system information
        run: |
          echo "=== System Information ==="
          echo "CPU cores: $(sysctl -n hw.ncpu)"
          echo "CPU info:"
          sysctl -n machdep.cpu.brand_string
          echo ""
          echo "=== Memory Information ==="
          echo "Total Memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
          echo ""
          echo "=== Disk Information ==="
          df -h

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: ${{ env.SCCACHE_VERSION }}

      - name: Restore LLVM Source Cache
        id: cache-llvm
        uses: actions/cache/restore@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Clone LLVM Project
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=llvmorg-${{ env.LLVM_VERSION }} https://github.com/llvm/llvm-project.git

      - name: Save LLVM Source Cache (before patches)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Apply patches
        run: |
          git -C llvm-project apply --verbose --ignore-whitespace --whitespace=fix ../patches/wasm32-cross-compilation.patch

      - name: Configure CMake
        run: |
          cp cmake/CMakePresets.json llvm-project/llvm/
          cmake --preset macos-arm64 -S llvm-project/llvm -B build \
                -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: |
          echo "=== Building ==="
          ninja -C build runtimes

      - name: Install
        run: |
          echo "=== Installing ==="
          ninja -C build runtimes/install
          ninja -C build tools/flang/tools/install
          ninja -C build tools/llvm-nm/install
          ninja -C build tools/llvm-ar/install

      - name: Setup Emscripten
        run: |
          curl -fsSL "https://storage.googleapis.com/webassembly/emscripten-releases-builds/mac/${{ env.EMSDK_HASH }}/wasm-binaries-arm64.tar.xz" -o emsdk.tar.xz
          mkdir -p emsdk
          tar -xf emsdk.tar.xz -C emsdk --strip-components=1
          echo "$PWD/emsdk/bin" >> $GITHUB_PATH
          echo "$PWD/emsdk/emscripten" >> $GITHUB_PATH

      - name: Test wasm32 cross-compilation
        run: |
          emcc --generate-config
          python3 scripts/test-wasm32.py --install-dir=./install --build-dir=./build

      - name: Package binaries
        run: |
          mv install flang+llvm-${{ env.LLVM_VERSION }}
          tar -czf flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz flang+llvm-${{ env.LLVM_VERSION }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}
          path: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz
          retention-days: 30
