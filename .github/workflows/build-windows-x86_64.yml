---
name: build flang for windows (x86_64)

on:
  push:
    branches: [master]
    paths:
      - '.github/workflows/build-windows-x86_64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
  pull_request:
    branches: [master]
    paths:
      - '.github/workflows/build-windows-x86_64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build-windows-x86_64:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      SCCACHE_GHA_ENABLED: "true"
      CMAKE_C_COMPILER_LAUNCHER: "sccache"
      CMAKE_CXX_COMPILER_LAUNCHER: "sccache"
      TARGET_TRIPLE: "x86_64-pc-windows-msvc"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load version configuration
        shell: bash
        run: |
          source versions.env
          echo "LLVM_VERSION=$LLVM_VERSION" >> $GITHUB_ENV
          echo "SCCACHE_VERSION=$SCCACHE_VERSION" >> $GITHUB_ENV

      - name: Show system information
        shell: pwsh
        run: |
          Write-Host "=== System Information ==="
          Write-Host "CPU cores: $([Environment]::ProcessorCount)"
          Write-Host "CPU info:"
          Get-CimInstance -ClassName Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors | Format-List
          Write-Host "`n=== Memory Information ==="
          $memory = Get-CimInstance -ClassName Win32_ComputerSystem
          Write-Host "Total Physical Memory: $([math]::Round($memory.TotalPhysicalMemory / 1GB, 2)) GB"
          Write-Host "`n=== Disk Information ==="
          Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Used -gt 0} | Select-Object Name, @{Name="Size(GB)";Expression={[math]::Round($_.Used/1GB + $_.Free/1GB, 2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB, 2)}} | Format-Table

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: ${{ env.SCCACHE_VERSION }}

      - name: Restore LLVM Source Cache
        id: cache-llvm
        uses: actions/cache/restore@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}
          enableCrossOsArchive: true

      - name: Clone LLVM Project
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=llvmorg-${{ env.LLVM_VERSION }} https://github.com/llvm/llvm-project.git --config core.autocrlf=input

      - name: Save LLVM Source Cache (before patches)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}
          enableCrossOsArchive: true

      - name: Apply patches
        run: |
          git -C llvm-project apply --verbose --ignore-whitespace --whitespace=fix ../patches/disable-flang-pch-for-sccache.patch
          git -C llvm-project apply --verbose --ignore-whitespace --whitespace=fix ../patches/flang-rt-static-only.patch

      - name: Configure CMake
        run: |
          copy cmake\CMakePresets.json llvm-project\llvm\
          cmake --preset windows-x86_64 -S llvm-project/llvm -B build `
                -DCMAKE_C_COMPILER_LAUNCHER=sccache `
                -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: |
          echo "=== Building ==="
          ninja -C build runtimes

      - name: Install
        run: |
          echo "=== Installing ==="
          ninja -C build runtimes/install
          ninja -C build tools/flang/tools/install
          ninja -C build tools/llvm-nm/install
          ninja -C build tools/llvm-ar/install

      - name: Package binaries
        shell: pwsh
        run: |
          $out = "flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.zip"
          Rename-Item -Path install -NewName flang+llvm-${{ env.LLVM_VERSION }}
          Compress-Archive -Path flang+llvm-${{ env.LLVM_VERSION }} -DestinationPath $out -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}
          path: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.zip
          retention-days: 30
