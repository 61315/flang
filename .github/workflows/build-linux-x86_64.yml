---
name: build flang for linux (x86_64)

on:
  push:
    branches: [master]
    paths:
      - '.github/workflows/build-linux-x86_64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
  pull_request:
    branches: [master]
    paths:
      - '.github/workflows/build-linux-x86_64.yml'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
  workflow_dispatch:
  workflow_call:

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      SCCACHE_GHA_ENABLED: "true"
      CMAKE_C_COMPILER_LAUNCHER: "sccache"
      CMAKE_CXX_COMPILER_LAUNCHER: "sccache"
      TARGET_TRIPLE: "x86_64-unknown-linux-gnu"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load version configuration
        run: |
          source versions.env
          echo "LLVM_VERSION=$LLVM_VERSION" >> $GITHUB_ENV
          echo "SCCACHE_VERSION=$SCCACHE_VERSION" >> $GITHUB_ENV

      - name: Show system information
        run: |
          echo "=== System Information ==="
          echo "CPU cores: $(nproc)"
          echo "CPU info:"
          lscpu | grep -E "Model name|CPU\(s\)|Thread|Core"
          echo ""
          echo "=== Memory Information ==="
          free -h
          echo ""
          echo "=== Disk Information ==="
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: ${{ env.SCCACHE_VERSION }}

      - name: Restore LLVM Source Cache
        id: cache-llvm
        uses: actions/cache/restore@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Clone LLVM Project
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=llvmorg-${{ env.LLVM_VERSION }} https://github.com/llvm/llvm-project.git

      - name: Save LLVM Source Cache (before patches)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Configure CMake
        run: |
          cp cmake/CMakePresets.json llvm-project/llvm/
          cmake --preset linux-x86_64 -S llvm-project/llvm -B build \
                -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: |
          echo "=== Building ==="
          ninja -C build runtimes

      - name: Install
        run: |
          echo "=== Installing ==="
          ninja -C build runtimes/install
          ninja -C build tools/flang/tools/install
          ninja -C build tools/llvm-nm/install
          ninja -C build tools/llvm-ar/install

      - name: Package binaries
        run: |
          mv install flang+llvm-${{ env.LLVM_VERSION }}
          tar -czf flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz flang+llvm-${{ env.LLVM_VERSION }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}
          path: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz
          retention-days: 30
