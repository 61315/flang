---
name: build flang for linux (x86_64)

on:
  push:
    branches: [master]
    paths:
      - '.github/workflows/build-linux-x86_64.yml'
      - 'docker/llvm-musl-builder/**'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
      - 'Makefile.wasm32'
      - 'scripts/**'
  pull_request:
    branches: [master]
    paths:
      - '.github/workflows/build-linux-x86_64.yml'
      - 'docker/llvm-musl-builder/**'
      - 'cmake/CMakePresets.json'
      - 'versions.env'
      - 'patches/**'
      - 'Makefile.wasm32'
      - 'scripts/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    env:
      SCCACHE_GHA_ENABLED: "true"
      TARGET_TRIPLE: "x86_64-unknown-linux-gnu"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load version configuration
        run: |
          source versions.env
          echo "LLVM_VERSION=$LLVM_VERSION" >> $GITHUB_ENV
          echo "SCCACHE_VERSION=$SCCACHE_VERSION" >> $GITHUB_ENV
          echo "NINJA_VERSION=$NINJA_VERSION" >> $GITHUB_ENV
          echo "EMSDK_VERSION=$EMSDK_VERSION" >> $GITHUB_ENV
          echo "EMSDK_HASH=$EMSDK_HASH" >> $GITHUB_ENV

      - name: Show system information
        run: |
          echo "=== System Information ==="
          echo "CPU cores: $(nproc)"
          echo "CPU info:"
          lscpu | grep -E "Model name|CPU\(s\)|Thread|Core"
          echo ""
          echo "=== Memory Information ==="
          free -h
          echo ""
          echo "=== Disk Information ==="
          df -h

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: ${{ env.SCCACHE_VERSION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t llvm-musl-builder:latest -f docker/llvm-musl-builder/Dockerfile .

      - name: Restore LLVM Source Cache
        id: cache-llvm
        uses: actions/cache/restore@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Clone LLVM Project
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 --branch=llvmorg-${{ env.LLVM_VERSION }} https://github.com/llvm/llvm-project.git

      - name: Save LLVM Source Cache (before patches)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: llvm-project
          key: llvm-source-${{ env.LLVM_VERSION }}

      - name: Configure, Build and Install
        env:
          NINJA_VERSION: ${{ env.NINJA_VERSION }}
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -v "${HOME}/.cache/sccache:/cache/sccache" \
            -e SCCACHE_DIR=/cache/sccache \
            -e ACTIONS_CACHE_SERVICE_V2="${ACTIONS_CACHE_SERVICE_V2}" \
            -e ACTIONS_RESULTS_URL="${ACTIONS_RESULTS_URL}" \
            -e ACTIONS_RUNTIME_TOKEN="${ACTIONS_RUNTIME_TOKEN}" \
            -e SCCACHE_GHA_ENABLED="true" \
            -e NINJA_VERSION="${NINJA_VERSION}" \
            llvm-musl-builder:latest \
            /bin/bash -c '
              set -e

              export CMAKE_C_COMPILER_LAUNCHER="sccache"
              export CMAKE_CXX_COMPILER_LAUNCHER="sccache"

              echo "=== Installing Ninja ${NINJA_VERSION} ==="
              cd /tmp
              wget -q https://github.com/ninja-build/ninja/archive/refs/tags/v${NINJA_VERSION}.tar.gz
              tar xzf v${NINJA_VERSION}.tar.gz
              cd ninja-${NINJA_VERSION}
              cmake -B build \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_TESTING=OFF
              cmake --build build -j$(nproc)
              cp build/ninja /usr/local/bin/
              ninja --version
              cd /work

              mkdir -p /work/build /work/install

              echo "=== Applying patches ==="
              git -C /work/llvm-project apply --verbose --ignore-whitespace --whitespace=fix /work/patches/wasm32-cross-compilation.patch

              echo "=== Configuring CMake (Static Build) ==="
              cp /work/cmake/CMakePresets.json /work/llvm-project/llvm/
              cmake --preset linux-static-x86_64 -S /work/llvm-project/llvm -B /work/build \
                    -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                    -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

              echo "=== Building ==="
              ninja -C /work/build runtimes

              echo "=== Installing ==="
              ninja -C /work/build runtimes/install
              ninja -C /work/build tools/flang/tools/install
              ninja -C /work/build tools/llvm-nm/install
              ninja -C /work/build tools/llvm-ar/install

              echo "=== sccache Statistics ==="
              sccache --show-stats

              echo "=== Fixing permissions ==="
              chown -R $(stat -c %u:%g /work) /work/build /work/install
            '

      - name: Setup Emscripten
        run: |
          curl -fsSL "https://storage.googleapis.com/webassembly/emscripten-releases-builds/linux/${{ env.EMSDK_HASH }}/wasm-binaries.tar.xz" -o emsdk.tar.xz
          mkdir -p emsdk
          tar -xf emsdk.tar.xz -C emsdk --strip-components=1
          echo "$PWD/emsdk/bin" >> $GITHUB_PATH
          echo "$PWD/emsdk/emscripten" >> $GITHUB_PATH

      - name: Test wasm32 cross-compilation
        run: |
          emcc --generate-config
          python3 scripts/test-wasm32.py --install-dir=./install --build-dir=./build

      - name: Package binaries
        run: |
          mv install flang+llvm-${{ env.LLVM_VERSION }}
          tar czf flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz flang+llvm-${{ env.LLVM_VERSION }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}
          path: flang+llvm-${{ env.LLVM_VERSION }}-${{ env.TARGET_TRIPLE }}.tar.gz
          retention-days: 30
