---
name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to release (e.g., v21.1.3). Leave empty to use versions.env'
        required: false
        default: ''
      version:
        description: 'Version string for artifact names (e.g., 21.1.3). Leave empty to use versions.env'
        required: false
        default: ''
      rebuild:
        description: 'Force rebuild? (rebuild all platforms / use existing artifacts)'
        required: true
        default: 'false'
        type: boolean
      draft:
        description: 'Create release as draft?'
        required: true
        default: 'true'
        type: boolean

jobs:
  build-windows-x86_64:
    if: ${{ github.event.inputs.rebuild == 'true' }}
    uses: ./.github/workflows/build-windows-x86_64.yml

  build-linux-x86_64:
    if: ${{ github.event.inputs.rebuild == 'true' }}
    uses: ./.github/workflows/build-linux-x86_64.yml

  build-linux-arm64:
    if: ${{ github.event.inputs.rebuild == 'true' }}
    uses: ./.github/workflows/build-linux-arm64.yml

  build-macos-x86_64:
    if: ${{ github.event.inputs.rebuild == 'true' }}
    uses: ./.github/workflows/build-macos-x86_64.yml

  build-macos-arm64:
    if: ${{ github.event.inputs.rebuild == 'true' }}
    uses: ./.github/workflows/build-macos-arm64.yml

  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set release variables
        id: vars
        run: |
          # Load defaults from versions.env
          source versions.env

          # Use input if provided, otherwise use versions.env, otherwise use git tag
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${LLVM_VERSION}"
          fi

          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="v${VERSION}"
          fi

          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using TAG_NAME=${TAG_NAME}, VERSION=${VERSION}"

      - name: Download artifacts (from this or previous workflow runs)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.vars.outputs.VERSION }}
        run: |
          set -e
          mkdir -p artifacts
          names=( \
            "flang+llvm-${VERSION}-x86_64-pc-windows-msvc" \
            "flang+llvm-${VERSION}-x86_64-unknown-linux-gnu" \
            "flang+llvm-${VERSION}-aarch64-unknown-linux-gnu" \
            "flang+llvm-${VERSION}-x86_64-apple-darwin" \
            "flang+llvm-${VERSION}-arm64-apple-darwin" \
          )

          repo="${GITHUB_REPOSITORY}"

          download_artifact() {
            name="$1"
            echo "Looking for artifact: $name"

            response_and_code=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer ${GITHUB_TOKEN}" "https://api.github.com/repos/${repo}/actions/artifacts?per_page=100")
            response=$(echo "$response_and_code" | head -n -1)
            code=$(echo "$response_and_code" | tail -n1)

            if [ "$code" != "200" ]; then
              echo "Error fetching artifacts for $name: HTTP $code"
              echo "$response"
              return
            fi
            id=$(echo "$response" | jq -r '.artifacts // [] | .[] | select(.name=="'"$name"'") | .id' | head -n1)

            if [ -z "$id" ] || [ "$id" = "null" ]; then
              echo "Artifact not found for $name"
              return
            fi
            echo "Found artifact id=$id, downloading..."

            curl -sL -H "Authorization: Bearer ${GITHUB_TOKEN}" -o /tmp/${id}.zip "https://api.github.com/repos/${repo}/actions/artifacts/${id}/zip"
            unzip -q /tmp/${id}.zip -d ./artifacts/
          }

          pids=()
          for name in "${names[@]}"; do
            download_artifact "$name" &
            pids+=( $! )
          done

          for pid in "${pids[@]}"; do
            wait $pid
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.TAG_NAME }}
          name: flang+llvm-${{ steps.vars.outputs.VERSION }}
          draft: ${{ github.event.inputs.draft == 'true' }}
          prerelease: false
          files: |
            ./artifacts/flang+llvm-${{ steps.vars.outputs.VERSION }}-x86_64-pc-windows-msvc.zip
            ./artifacts/flang+llvm-${{ steps.vars.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz
            ./artifacts/flang+llvm-${{ steps.vars.outputs.VERSION }}-aarch64-unknown-linux-gnu.tar.gz
            ./artifacts/flang+llvm-${{ steps.vars.outputs.VERSION }}-x86_64-apple-darwin.tar.gz
            ./artifacts/flang+llvm-${{ steps.vars.outputs.VERSION }}-arm64-apple-darwin.tar.gz
